+++
# --- MDTM Task ---
id = "TASK-DEBUG-20250505-172400"
title = "Debug 'N/A' Values in Dashboard Run Summary"
status = "🟢 Done"
type = "🐞 Bug"
created_date = "2025-05-05"
updated_date = "2025-05-05" # Consider updating this date if needed
assigned_to = "debug"
coordinator = "roo-commander"
priority = "High"
tags = ["dashboard", "frontend", "streamlit", "api", "debug", "bug", "na-values"]
related_docs = ["run_dashboard.py", "dashboard/main.py", "dashboard/api.py", "dashboard/utils.py", "reinforcestrategycreator/api/routers/runs.py"]
# --- Bug Report ---
# **Observed Behavior:** The "Run Summary" section in the dashboard (run via `run_dashboard.py`) displays "N/A" for some metrics.
# **Expected Behavior:** The dashboard should display the calculated summary metrics fetched from the API.
# **Context:** Analysis confirmed the backend API endpoint (`/runs/{run_id}/episodes/summary/`) returns valid numeric data when called directly (e.g., via curl). The individual episode details section *does* display data correctly.
# **Hypothesis:** The issue likely lies within the data fetching (`dashboard/api.py::fetch_api_data`) or formatting (`dashboard/utils.py::format_metric`) logic used by `dashboard/main.py`. It might be returning `None`, encountering a type mismatch, or having a subtle formatting error causing `format_metric` or `st.metric` to fail silently or return "N/A".
# --- Acceptance Criteria ---
# - AC1: The root cause of `fetch_api_data` returning `None` for the summary endpoint is identified.
# - AC2: The "Run Summary" section in the dashboard correctly displays the numeric values for Avg PnL, Avg Sharpe Ratio, and Avg Win Rate fetched from the API.
# - AC3: Appropriate error handling or logging is added if the issue is intermittent or related to API availability.
+++

# Debug 'N/A' Values in Dashboard Run Summary

## 1. Problem Description

The "Run Summary" section of the Streamlit dashboard (`dashboard_enhanced_v2.py`) consistently shows "N/A" for key performance indicators like Average PnL, Average Sharpe Ratio, and Average Win Rate. However, direct calls to the corresponding API endpoint (`/runs/{run_id}/episodes/summary/`) return valid data, and the individual episode details section displays correctly.

## 2. Investigation Steps & Findings (from roo-commander)

1.  **Verified API Endpoint:** Used `curl` to call `/runs/{latest_run_id}/episodes/summary/`. The API returned a valid JSON response with numeric values for all summary metrics.
2.  **Analyzed Frontend Code:**
    *   The dashboard calls `fetch_run_summary(run_id)` (line 1002).
    *   `fetch_run_summary` calls the generic `fetch_api_data(endpoint)` helper (line 85).
    *   `fetch_api_data` (lines 33-73) handles the API call, caching (`@st.cache_data`), and error handling (returns `None` on error).
    *   The display logic uses `format_metric(run_summary.get('metric_name'), type)` (lines 1006-1009).
    *   `format_metric` (lines 878-899) returns "N/A" only if the input value is `None`.
3.  **Conclusion:** The issue is likely within the frontend code. The `fetch_api_data` function, when called for the summary endpoint, is probably returning `None`. This could be due to:
    *   An error occurring *during* the request within the `try...except` block of `fetch_api_data`.
    *   An issue with Streamlit's `@st.cache_data`.
    *   An unexpected parsing failure specific to the summary response within `fetch_api_data`.

## 3. Debugging Plan / Checklist (Targeting `run_dashboard.py` -> `dashboard/` package)

-   [ ] **Review Logs:** Check the application logs for errors related to `fetch_api_data` or the summary endpoint when `run_dashboard.py` is executed.
-   [✅] **Add Logging (API):** Added detailed logging within `dashboard/api.py::fetch_api_data` (lines 28-44) to log raw response, parsed JSON, and value types for the summary endpoint.
-   [ ] **Test Caching:** Caching is not used by default in `dashboard/api.py::fetch_api_data`. (Skipped)
-   [✅] **Inspect `summary` (Main):** Added `st.write` to `dashboard/main.py` (Removed after debugging).
-   [✅] **Identify Root Cause:** Determined the root cause: `dashboard/main.py` was using incorrect dictionary keys (e.g., `pnl` instead of `average_pnl`) when accessing the `summary` data returned by the API, causing `summary.get()` to return `None`.
-   [✅] **Implement Fix:** Updated `dashboard/main.py` (lines 109-119) to use the correct keys (`average_pnl`, `average_win_rate`, etc.) provided by the `/episodes/summary/` API endpoint. Removed debugging code from `dashboard/api.py` and `dashboard/main.py`.
-   [✅] **Verify Fix:** User confirmed via chat (2025-05-05 17:37) that the "Run Summary" section now displays correct numeric values after running `run_dashboard.py`.

## 4. Notes / Logs

*(Add logs during debugging)*
*   **2025-05-05 17:33:** Redirected debugging focus from `dashboard_enhanced_v2.py` to `run_dashboard.py` and its underlying `dashboard/` package modules based on user feedback. Added logging to `dashboard/api.py` and `dashboard/main.py`.