+++
# --- MDTM Task: Investigate NaN Asset Price in Dashboard ---
id = "TASK-BACKEND-20250505-221126"
title = "Investigate and Fix NaN asset_price Issue Leading to Insufficient Data"
status = "âšª Blocked" # Blocked pending frontend investigation
type = "ðŸž Bug"
created_date = "2025-05-05"
updated_date = "2025-05-05" # Update this date
assigned_to = "lead-frontend" # Reassign to Frontend Lead
coordinator = "TASK-CMD-..." # Replace with actual Commander Task ID if available
priority = "Critical"
tags = ["bugfix", "backend", "frontend", "data", "nan", "asset_price", "api", "database", "dashboard", "analysis"] # Added frontend tag
related_tasks = ["TASK-BACKEND-20250505-211848", "TASK-DB-20250505-212500", "TASK-API-20250505-212200", "TASK-API-20250505-213300"] # Related to previous changes
related_docs = ["dashboard/api.py", "dashboard/analysis.py", "reinforcestrategycreator/api/routers/episodes.py", "reinforcestrategycreator/db_models.py", "train.py"]
# --- User & Environment Context ---
user_feedback = """
Dashboard shows 'Insufficient data for decision analysis.'
Logs show: 'WARNING - No valid steps data after dropping NaN asset_price.'
"""
# Issue appears after fetching steps data for analysis.
# The newly added 'asset_price' column seems to be entirely NaN or null.
+++

# Task: Investigate and Fix NaN `asset_price` Issue

## 1. Description

Following recent changes to add `asset_price` to the `Step` model and related components, the dashboard now fails to perform decision analysis, showing "Insufficient data". Logs reveal a warning: "No valid steps data after dropping NaN asset_price." This indicates that the `asset_price` column in the steps DataFrame used by the dashboard contains only NaN values.

## 2. Root Cause Investigation Areas

*   **Data Storage:** Verify if `asset_price` is being correctly calculated and stored in the database during the training process (`train.py`, `trading_environment.py`, `db_utils.py`). Check the database directly for a recent run/episode.
*   **API Serialization/Serving:** Ensure the API endpoint (`reinforcestrategycreator/api/routers/episodes.py` -> `/episodes/{id}/steps/`) correctly retrieves and serializes the `asset_price` from the database. Check the raw API response.
*   **Dashboard API Client:** Examine how `dashboard/api.py` fetches and parses the steps data. Ensure `asset_price` is correctly handled and not inadvertently converted to NaN during DataFrame creation or initial processing.
*   **Analysis Preprocessing:** Check if any steps in `dashboard/analysis.py` (or related functions called before the `dropna`) might be causing `asset_price` to become NaN.

## 3. Acceptance Criteria

*   Identify the root cause of the `asset_price` column containing only NaN values when used by the dashboard analysis functions.
*   Implement the necessary fix (e.g., in training logic, API endpoint, or dashboard data fetching/processing).
*   Verify that the dashboard can successfully fetch steps data with valid (non-NaN) `asset_price` values.
*   Confirm that the "Detailed Decision Analysis" section now displays calculated metrics instead of the "Insufficient data" message.

## 4. Checklist

*   [x] Check `asset_price` values directly in the database for a recent episode's steps. Are they valid numbers or NULL/NaN?
*   [x] Inspect the raw JSON response from the `/api/v1/episodes/{id}/steps/` endpoint. Does it contain valid `asset_price` values? (**Confirmed: API now returns dicts with valid `asset_price`**)
*   [ ] Review the data loading and DataFrame creation logic in `dashboard/api.py` (`fetch_episode_steps`). (**Frontend Task**)
*   [x] Review the training logic in `train.py` and `trading_environment.py` to ensure `asset_price` is correctly captured and passed for saving. (**Identified: `train.py` uses wrong key**)
*   [x] Review the database saving logic for `Step` objects (within `train.py`). (**Identified: `asset_price` field was missing in constructor**)
*   [x] Implement the fix based on the identified root cause. (**Applied fix to `train.py`**)
*   [ ] Rerun the dashboard and verify the "Insufficient data" message is gone and metrics are displayed. (**Frontend Task**)
*   [ ] Check logs for the "No valid steps data after dropping NaN asset_price" warning; ensure it no longer appears. (**Frontend Task**)

## 5. Implementation Notes & Logs

*   **2025-05-05 22:12:** Executed `check_asset_price_db.py`. Confirmed that for the latest episode (ID 10), all 972 steps have `NULL` for `asset_price` in the database. Root cause is likely in data capture (training/environment) or saving logic.
*   **2025-05-05 22:13:** Reviewed `train.py` and `trading_environment.py`. Found that `trading_environment.py` returns the asset price in `info['current_price']`, but `train.py` was not assigning this value to the `asset_price` field when creating the `Step` database object.
*   **2025-05-05 22:13:** Applied fix to `train.py` to correctly assign `info.get('current_price')` to `Step.asset_price`.
*   **2025-05-05 22:26:** Reran `train.py` to generate new data with the fix applied. Training completed successfully.
*   **2025-05-05 22:26:** Reran `train.py` to generate new data with the fix applied. Training completed successfully.
*   **2025-05-05 22:30 - 23:10:** Investigated API serialization issues. Confirmed database has correct `asset_price` values after training fix. Multiple attempts to serialize via Pydantic `schemas.Step` failed to include `asset_price`. Reverted API to return raw dictionaries for steps. API logs now show correct `asset_price` in dictionaries. Dashboard still shows "Insufficient data".
*   **2025-05-05 23:12:** Issue likely lies in frontend (`dashboard/api.py` or `dashboard/analysis.py`) handling of the API response (expecting Pydantic objects?) or subsequent processing. Reassigning to `lead-frontend`.
*(Backend specialist will add notes here during execution)*