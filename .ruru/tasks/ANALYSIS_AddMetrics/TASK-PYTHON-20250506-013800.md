+++
# --- MDTM Task File ---
id = "TASK-PYTHON-20250506-013800"
title = "Modify analyze_results.py to Calculate Total Return % and Avg Sharpe"
status = "🟢 Done" # Options: 🟡 To Do, 🟠 In Progress, 🟢 Done, ⚪ Blocked, 🟣 Review
type = "🛠️ Refactor" # Options: 🌟 Feature, 🐞 Bug, 🛠️ Refactor, 🧪 Test, 📄 Documentation, 🔬 Analysis, ⚙️ Chore
created_date = "2025-05-06"
updated_date = "2025-05-06" # Date already correct, no change needed here, but keeping for structure
assigned_to = "dev-python" # Mode slug
coordinator = "TASK-CMD-..." # Replace with actual Commander Task ID if available
priority = "Critical" # Needed before starting optimization loop
complexity = "Low"
estimated_effort = "1h"
related_tasks = ["TASK-PYTHON-20250506-013600"] # Related to benchmark/evaluation setup
target_branch = "feature/rl-strategy-enhancements"
tags = ["analysis", "metrics", "python", "refactor", "evaluation"]
# --- End Metadata ---
+++

# Modify analyze_results.py to Calculate Total Return % and Avg Sharpe

## 1. Description

The `analyze_results.py` script needs to be modified to calculate and report the specific metrics required for the automated optimization loop's stopping conditions.

Currently, it calculates metrics per episode but doesn't output the overall run performance clearly.

Modify the script to:
1.  Calculate the **Overall Total Return %** for the analyzed run. Assume this should be calculated based on the initial portfolio value of the *first* episode and the final portfolio value of the *last* episode of the run.
2.  Calculate the **Average Sharpe Ratio** across all episodes within the analyzed run.
3.  Log these two calculated values clearly in the script's output.

## 2. Acceptance Criteria

*   The `calculate_metrics_from_db` function (or main part of the script) is updated.
*   The script correctly calculates the Overall Total Return % using the first episode's initial value and the last episode's final value.
*   The script correctly calculates the Average Sharpe Ratio using the `sharpe_ratio` column from the `episodes` data.
*   The script logs the calculated Overall Total Return % and Average Sharpe Ratio using `logging.info`.
*   The changes are committed to the `feature/rl-strategy-enhancements` branch.

## 3. Checklist

*   [✅] Read `analyze_results.py` to locate metric calculation logic.
*   [✅] In `calculate_metrics_from_db` (or `main`), access the `episodes` DataFrame.
*   [✅] Get `initial_portfolio_value` from the first episode row.
*   [✅] Get `final_portfolio_value` from the last episode row.
*   [✅] Calculate Total Return % = `((last_final_value / first_initial_value) - 1) * 100`. Handle potential division by zero or missing data.
*   [✅] Calculate Average Sharpe Ratio = `episodes_df['sharpe_ratio'].mean()`. Handle potential NaNs.
*   [✅] Add `logging.info` statements to print these calculated values clearly.
*   [✅] Test the script with a known `run_id` from the database to ensure correct calculation and logging.
*   [✅] Commit changes to the `feature/rl-strategy-enhancements` branch following commit standards (Rule `07`).

## 4. Logs / Notes

*   (2025-05-06) Modified `analyze_results.py` to calculate and log Overall Total Return % and Average Sharpe Ratio in `calculate_metrics_from_db`. Tested successfully with `poetry run python analyze_results.py`. Committed changes (Commit ID: 6f45544).