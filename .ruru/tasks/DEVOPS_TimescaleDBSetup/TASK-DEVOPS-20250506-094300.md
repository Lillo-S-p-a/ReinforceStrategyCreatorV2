+++
id = "TASK-DEVOPS-20250506-094300"
title = "Setup TimescaleDB Docker Container & Apply Market Data Schema"
status = "ðŸŸ¢ Done"
type = "ðŸš€ DevOps"
created_date = "2025-05-06"
updated_date = "2025-05-06"
assigned_to = "lead-devops"
coordinator = "TASK-CMD-20250506-094000" # Roo Commander Session Reference for this initiative
priority = "High"
complexity = "Medium"
estimated_effort = "3h"
related_tasks = ["TASK-ARCH-20250506-094000"] # Depends on the design from core-architect
tags = ["devops", "docker", "postgresql", "timescaledb", "database-setup", "schema", "infrastructure"]
target_branch = "feature/timeseries-db" # Or main/develop if infra changes go there
+++

# Setup TimescaleDB Docker Container & Apply Market Data Schema

## 1. Description

This task involves implementing the infrastructure for the new timeseries database designed to store historical market data. The design specifications are detailed in the architecture task file: `.ruru/tasks/ARCH_TimeseriesDBDesign/TASK-ARCH-20250506-094000.md`.

**Key Responsibilities:**
1.  **Docker Setup:**
    *   Integrate the provided `docker-compose.yml` snippet for the `timescaledb` service into the project's main `docker-compose.yml` file (or create one if it doesn't exist).
    *   Ensure the Docker configuration correctly sets up a new PostgreSQL container with the TimescaleDB extension (e.g., using `timescale/timescaledb:latest-pg16`).
    *   Configure environment variables for database user, password, and database name (e.g., `TIMESCALEDB_USER`, `TIMESCALEDB_PASSWORD`, `TIMESCALEDB_DB`). Ensure these are sourced from a `.env` file or a secure configuration management system.
    *   Set up persistent Docker volumes for the TimescaleDB data to ensure data is not lost on container restart.
    *   Configure Docker networking (e.g., `app-network`) so that other application services can connect to this new database container.
2.  **Schema Application:**
    *   Connect to the newly created TimescaleDB instance.
    *   Execute the DDL SQL script (provided in `TASK-ARCH-20250506-094000.md`) to:
        *   Create the `market_data` table.
        *   Convert `market_data` into a TimescaleDB hypertable, partitioned by `timestamp`.
        *   Create the `ix_ticker_timestamp` unique index and any other specified indexes.
3.  **Verification:**
    *   Confirm that the TimescaleDB container starts correctly and is accessible.
    *   Verify that the `market_data` table and its hypertable properties are correctly established.
    *   Ensure that basic connectivity to the database from another service or a local PSQL client is possible using the configured credentials and network settings.

## 2. Acceptance Criteria

*   The `timescaledb` service is successfully added to the project's `docker-compose.yml` and functions correctly.
*   The PostgreSQL container with TimescaleDB extension is running and persistent.
*   The `market_data` table schema (including hypertable conversion and indexes) as defined in `TASK-ARCH-20250506-094000.md` is successfully applied to the database.
*   The database is accessible on the configured Docker network (e.g., `app-network`) using the specified service name (e.g., `timescaledb`) and port.
*   Environment variables for database connection are properly configured and documented (e.g., in a sample `.env` file).

## 3. Checklist

*   [âœ…] Review Docker configuration snippet from `TASK-ARCH-20250506-094000.md`.
*   [âœ…] Integrate TimescaleDB service into the main `docker-compose.yml`.
*   [âœ…] Configure necessary environment variables (e.g., in `.env` or CI/CD variables).
*   [âœ…] Define and test Docker volume for data persistence.
*   [âœ…] Configure Docker networking for inter-service communication.
*   [âœ…] Build and start the Docker environment with the new TimescaleDB service.
*   [âœ…] Connect to the TimescaleDB instance.
*   [âœ…] Execute the DDL script to create the `market_data` table.
*   [âœ…] Execute `SELECT create_hypertable(...)` command.
*   [âœ…] Execute `CREATE UNIQUE INDEX ...` command and other specified indexes.
*   [âœ…] Verify table structure, hypertable status, and indexes using `psql` or a DB tool.
*   [âœ…] Test basic connectivity from another service or local client.
*   [âœ…] Document any setup steps or environment variable changes in project README or relevant DevOps documentation.
*   [âœ…] Commit `docker-compose.yml` changes and any new configuration files to the `feature/timeseries-db` branch (or appropriate branch).

## 4. Logs / Notes

*(lead-devops will add notes, commands executed, and verification steps here)*

**2025-05-06 09:47 AM (CEST) - lead-devops**
*   Created `docker-compose.yml` with TimescaleDB service definition.
*   Added `TIMESCALEDB_USER`, `TIMESCALEDB_PASSWORD`, `TIMESCALEDB_DB` to `.env`.
*   Started TimescaleDB container: `docker compose up -d --build timescaledb`
    *   Removed obsolete `version` attribute from `docker-compose.yml` after warning.
*   Created `market_data` table: `docker exec -i timescaledb_market_data psql -U user -d marketdata -c "CREATE TABLE market_data (timestamp TIMESTAMPTZ NOT NULL, ticker TEXT NOT NULL, open NUMERIC, high NUMERIC, low NUMERIC, close NUMERIC, adjusted_close NUMERIC, volume BIGINT, sma_20 NUMERIC, ema_12 NUMERIC, rsi_14 NUMERIC, macd_line NUMERIC, macd_signal NUMERIC, macd_hist NUMERIC);"`
*   Created hypertable: `docker exec -i timescaledb_market_data psql -U user -d marketdata -c "SELECT create_hypertable('market_data', 'timestamp', chunk_time_interval => INTERVAL '7 days');"`
*   Created unique index: `docker exec -i timescaledb_market_data psql -U user -d marketdata -c "CREATE UNIQUE INDEX ix_ticker_timestamp ON market_data (ticker, timestamp DESC);"` (Initial attempt interrupted, second attempt confirmed it already existed).
*   Verified table structure: `docker exec -i timescaledb_market_data psql -U user -d marketdata -c "\d market_data"`
*   Verified hypertable status: `docker exec -i timescaledb_market_data psql -U user -d marketdata -c "SELECT * FROM timescaledb_information.hypertables WHERE hypertable_name = 'market_data';"`
*   Installed `libpq` for `psql` client: `brew install libpq`
*   Tested host connectivity: `export PGPASSWORD='password' && /opt/homebrew/opt/libpq/bin/psql -h localhost -p 5433 -U user -d marketdata -c "\conninfo" && unset PGPASSWORD` - Successful.
*   Updated `README.md` with TimescaleDB setup instructions.
*   Committed `docker-compose.yml` and `.env` changes: `git add docker-compose.yml .env && git commit -m "feat(devops): setup TimescaleDB for market data storage\n\nRefs: TASK-DEVOPS-20250506-094300"`