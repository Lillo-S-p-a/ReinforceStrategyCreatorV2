+++
# --- MDTM Task: Enhance Step DB Model ---
id = "TASK-DB-20250505-212500"
title = "DB: Add Asset Price to Step Model"
status = "ðŸŸ¢ Done"
type = "ðŸ”§ Refactor" # Or "ðŸŒŸ Feature" if considered an addition
created_date = "2025-05-05"
updated_date = "2025-05-05" # Will be updated by the system or manually if needed
assigned_to = "lead-db" # Or specific DB specialist
coordinator = "TASK-BACKEND-20250505-211848"
priority = "High" # Blocking API and Dashboard tasks
# estimate = "0.5h" # Rough estimate
tags = ["database", "schema", "sqlmodel", "step", "asset-price", "metrics", "api", "backend"]
related_tasks = ["TASK-BACKEND-20250505-211848", "TASK-API-20250505-212200"]
related_docs = [
    "reinforcestrategycreator/db_models.py", # Primary file to modify
    "reinforcestrategycreator/api/routers/episodes.py", # Consumer via API
    "dashboard/analysis.py" # Motivation
    ]
# --- User & Environment Context ---
user_request = "Add an 'asset_price' field to the 'Step' database model to store the underlying asset's price at each step."
# Relevant image/screenshot: N/A
# Key files: db_models.py
+++

# Task: DB: Add Asset Price to Step Model

## 1. Description

The current `Step` database model (defined in `reinforcestrategycreator/db_models.py` using SQLModel) stores information about each step within a trading episode, including `portfolio_value`, `reward`, and `action`. However, it lacks a field to store the actual price of the traded asset (e.g., closing price) at that step's timestamp.

This missing field prevents the API (`TASK-API-20250505-212200`) from providing this crucial data, which in turn blocks accurate calculation of decision analysis metrics in the dashboard (`TASK-BACKEND-20250505-211848`).

This task is to add an `asset_price` field (likely a `float`) to the `Step` model definition in `reinforcestrategycreator/db_models.py`.

## 2. Acceptance Criteria

*   Modify the `Step` class definition in `reinforcestrategycreator/db_models.py` to include a new field: `asset_price: float = Field(default=None, nullable=True)`. Consider if it should be nullable or have a default based on data availability during step creation. (Nullable might be safer initially).
*   Ensure the change is compatible with existing database records (e.g., using `nullable=True` avoids breaking existing rows if a migration isn't immediately performed, although populating historical data might be a follow-up task).
*   Consider if a database migration (e.g., using Alembic, if configured) is necessary or if the ORM handles the schema alteration sufficiently for development purposes. Document the decision.
*   Verify that the model definition is syntactically correct and integrates with SQLModel/SQLAlchemy.

## 3. Checklist

*   [âœ…] Locate the `Step` model definition in `reinforcestrategycreator/db_models.py`.
*   [âœ…] Add the `asset_price: float` field to the `Step` model, considering nullability. (Added as `asset_price = Column(Float, nullable=True)`)
*   [âœ…] Determine and document the need for a formal DB migration. (Documented below - formal migration recommended but not implemented in this task).
*   [âœ…] Verify the updated model definition. (Change applied successfully).
*   [ ] (Optional/Follow-up) Consider how historical `Step` records without `asset_price` will be handled or backfilled. (Requires migration/backfill script).

## 4. Implementation Notes & Logs

*   **2025-05-05:** Added `asset_price = Column(Float, nullable=True)` to the `Step` model in `db_models.py`.
*   **Migration:** A formal database migration (e.g., using Alembic) is recommended to apply this schema change robustly and handle existing data. This project currently lacks a migration setup. The `nullable=True` setting allows the application *potentially* to run without immediate errors for new data insertion if the database is recreated or supports implicit nullable column addition, but this is not guaranteed and doesn't handle historical data. Setting up Alembic is advised for future schema changes.