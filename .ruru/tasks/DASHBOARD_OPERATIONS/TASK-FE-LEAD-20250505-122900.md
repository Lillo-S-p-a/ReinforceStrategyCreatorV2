+++
id = "TASK-FE-LEAD-20250505-122900"
title = "Display Episode Price Chart with Trading Operation Markers"
status = "üî¥ Bug" # Re-opened: Markers not displaying (See feedback 2025-05-05 12:35)
type = "üåü Feature"
priority = "üîº High" # User requested feature
created_date = "2025-05-05"
updated_date = "2025-05-05" # Added debug logging
# due_date = ""
# estimated_effort = ""
assigned_to = "dev-python"
# reporter = "TASK-CMD-20250505-122000"
parent_task = "" # Or link to a higher-level dashboard feature task if exists
depends_on = ["TASK-BE-LEAD-20250505-122100"] # Depends on the backend API endpoint
related_docs = [
    "dashboard.py",
    "reinforcestrategycreator/api/schemas/operations.py", # Assuming schema location
    ".ruru/tasks/DASHBOARD_OPERATIONS/TASK-BE-LEAD-20250505-122100.md" # Backend task
    ]
tags = ["frontend", "dashboard", "streamlit", "visualization", "chart", "plotly", "api-integration", "operations"]
template_schema_doc = ".ruru/templates/toml-md/01_mdtm_feature.README.md" # Link to schema documentation
# ai_prompt_log = """"""
# review_checklist = []
# reviewed_by = ""
# key_learnings = ""
+++

# Display Episode Price Chart with Trading Operation Markers

## Description ‚úçÔ∏è

*   **What is this feature?** Add a new chart to the Streamlit dashboard (`dashboard.py`) that displays the price history for a selected episode, overlaid with markers indicating the timing and type of trading operations (Entry/Exit Long/Short).
*   **Why is it needed?** To allow users to visually analyze the agent's trading decisions in the context of price movements within an episode.
*   **Scope:** Modify `dashboard.py` to fetch data from the new `/episodes/{episode_id}/operations/` API endpoint, fetch corresponding price data (likely from the existing `/episodes/{episode_id}/steps/` endpoint data), and render an interactive chart using a suitable library (e.g., Plotly).
*   **Links:** Backend Task `TASK-BE-LEAD-20250505-122100` defines the API endpoint.

## Acceptance Criteria ‚úÖ

*   - [‚úÖ] When an episode is selected in the dashboard, a new chart is displayed below the existing metrics/charts.
*   - [‚úÖ] The chart shows the asset's price (e.g., 'Close' price) over time for the duration of the selected episode. (Note: Used Portfolio Value as proxy due to data availability in steps)
*   - [ ] Data for the chart is fetched from the `/episodes/{episode_id}/steps/` (for price) and `/episodes/{episode_id}/operations/` (for markers) API endpoints. (BUG: Markers not loading - Needs fix)
*   - [ ] Markers are plotted on the price line corresponding to the `timestamp` and `price` of each `TradingOperation`. (BUG: Markers not loading - Needs fix)
*   - [ ] Different marker styles/colors are used to distinguish between operation types: (BUG: Markers not loading - Needs fix)
    *   `ENTRY_LONG` (e.g., Green Up Triangle ‚ñ≤)
    *   `EXIT_LONG` (e.g., Green Down Triangle ‚ñº)
    *   `ENTRY_SHORT` (e.g., Red Down Triangle ‚ñº)
    *   `EXIT_SHORT` (e.g., Red Up Triangle ‚ñ≤)
    *   `HOLD` operations (if present in data) should likely be ignored for plotting.
*   - [ ] Hovering over a marker displays relevant information (e.g., Operation Type, Size, Price, Timestamp). (BUG: Markers not loading - Needs fix)
*   - [‚úÖ] The chart is interactive (zoom, pan). (Default Plotly interactivity)
*   - [ ] Error handling is implemented for API calls (e.g., display a message if operation data cannot be fetched). (BUG: Error message shown, root cause needs fixing - Needs fix)
*   - [‚úÖ] The dashboard layout remains clean and usable with the addition of the new chart.

## Implementation Notes / Sub-Tasks üìù

*   - [ ] Add a function in `dashboard.py` to fetch data from `/api/v1/episodes/{episode_id}/operations/`. Handle pagination if the API returns paginated results for operations. (`fetch_episode_operations` added - **Added DEBUG logging 2025-05-05 12:37** - Needs fix)
*   - [ ] Ensure the price data (likely from `steps` data, which seems to be already fetched) is available and aligned with the operation timestamps. You might need to merge or lookup prices based on timestamps. (Used portfolio value as proxy, markers use operation price/time - BUG: Investigate marker plotting - Needs fix)
*   - [ ] Use `plotly.graph_objects` to create the chart: (`create_price_operations_chart` added - **Added DEBUG logging 2025-05-05 12:37** - Needs fix)
    *   Add a `Scatter` trace for the price line. (Done within function)
    *   Add separate `Scatter` traces for each operation type, using `mode='markers'` and appropriate marker symbols/colors. Set the `x` and `y` coordinates based on operation `timestamp` and `price`. (Done within function)
*   - [‚úÖ] Integrate the chart creation logic into the main dashboard flow where episode details are displayed.
*   - [‚úÖ] Use `st.plotly_chart()` to render the chart.

## Diagrams üìä (Optional)

*   (Consider a simple wireframe sketch if helpful)

## AI Prompt Log ü§ñ (Optional)

*   (Log key prompts and AI responses)

## Review Notes üëÄ (For Reviewer)

*   Verify correct API endpoint usage.
*   Check marker placement and appearance for different operation types.
*   Test chart interactivity and hover information.
*   Assess error handling and overall dashboard layout.

## Key Learnings üí° (Optional - Fill upon completion)

*   (Summarize discoveries)