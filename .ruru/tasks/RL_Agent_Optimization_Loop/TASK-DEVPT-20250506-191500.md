+++
id = "TASK-DEVPT-20250506-191500"
title = "Develop Evaluation Script (evaluate_strategy.py) for RL Agent vs SPY Benchmark"
status = "üü¢ Done" # Options: üü° To Do, üü† In Progress, üü¢ Done, üî¥ Blocked, ‚ö™ Hold
type = "üõ†Ô∏è Chore" # Options: üåü Feature, üêû Bug, üõ†Ô∏è Chore, üß™ Test, üìñ Documentation, ‚ùì Question, ü§î Research, ‚ö†Ô∏è Issue
priority = "Critical" # Options: Critical, High, Medium, Low
created_date = "2025-05-06"
updated_date = "2025-05-06" # Will be updated by the system, but good to note
due_date = "" # Optional
assigned_to = "dev-python" # Mode slug
coordinator = "TASK-CMD-20250506-191200" # Master loop task ID
# effort = "Medium" # Optional: Small, Medium, Large, XL
# complexity = "Medium" # Optional: Low, Medium, High
tags = ["python", "evaluation-script", "rl-agent", "spy-benchmark", "metrics", "trading"]
related_docs = [
    "TASK-CMD-20250506-191200", # Master loop task
    "reinforcestrategycreator/metrics_calculator.py", # Potential reference
    "analyze_results.py" # Potential reference
]
# --- Git Context (Optional) ---
# branch = "feature/rl-strategy-enhancements" # Target branch for the script
# commit_hash = ""
+++

# Description

This task is to develop a new Python script, `evaluate_strategy.py`, which will be used to evaluate the performance of a trained Reinforcement Learning (RL) agent against a SPY (S&P 500 ETF) benchmark. This script is a critical component of the iterative optimization loop defined in `TASK-CMD-20250506-191200`.

The script should be placed in the root directory of the project.

**Key Functionalities:**

1.  **Load Trained Agent:**
    *   Accept a path to a saved model checkpoint (e.g., a `.pth` file or a JSON file containing model info if using a custom saving mechanism like in `production_models/`).
    *   Load the RL agent (likely from `reinforcestrategycreator.rl_agent`).

2.  **Backtest Agent:**
    *   Utilize the `TradingEnvironment` from `reinforcestrategycreator.trading_environment`.
    *   Run a backtest for the loaded agent over the period **2020-01-01 to 2023-12-31**.
    *   Collect necessary data to calculate performance metrics (e.g., portfolio values, trades).

3.  **Calculate Agent Metrics:**
    *   Using the backtest results, calculate the following metrics:
        *   Total Return %
        *   Sharpe Ratio (assume a risk-free rate, e.g., 0% or allow configuration)
        *   Maximum Drawdown
    *   Refer to `reinforcestrategycreator/metrics_calculator.py` for existing metric calculation logic if helpful.

4.  **Fetch SPY Benchmark Data:**
    *   Fetch historical price data for SPY for the same period: **2020-01-01 to 2023-12-31**.
    *   Use `yfinance` or a similar library, consistent with `reinforcestrategycreator.data_fetcher`.

5.  **Calculate SPY Benchmark Metrics:**
    *   Using the SPY historical data, calculate the same metrics:
        *   Total Return %
        *   Sharpe Ratio
        *   Maximum Drawdown

6.  **Output Results:**
    *   Clearly print or log the calculated metrics for both the RL agent and the SPY benchmark in a structured and comparable format.
    *   Example output:
        ```
        Evaluation Period: 2020-01-01 to 2023-12-31

        RL Agent Performance:
          Total Return: X.XX%
          Sharpe Ratio: Y.YY
          Max Drawdown: Z.ZZ%

        SPY Benchmark Performance:
          Total Return: A.AA%
          Sharpe Ratio: B.BB
          Max Drawdown: C.CC%
        ```

7.  **Configuration:**
    *   The script should be configurable via command-line arguments (using `argparse`):
        *   `--model-path`: Path to the saved agent model checkpoint (required).
        *   `--start-date`: Backtest start date (default: "2020-01-01").
        *   `--end-date`: Backtest end date (default: "2023-12-31").
        *   `--risk-free-rate`: Annualized risk-free rate for Sharpe Ratio (default: 0.0).
        *   `--output-file`: Optional path to save results (e.g., JSON or CSV).

# Acceptance Criteria

*   A Python script named `evaluate_strategy.py` is created in the project root.
*   The script successfully loads a trained RL agent model.
*   The script performs a backtest for the agent and SPY over the specified period (2020-2023).
*   The script accurately calculates Total Return %, Sharpe Ratio, and Max Drawdown for both the agent and SPY.
*   The script outputs these metrics in a clear, comparable format.
*   The script is configurable via CLI arguments as specified.
*   The script includes necessary imports, error handling, and comments for clarity.
*   The script is well-structured and follows Python best practices.
*   The script is committed to the `feature/rl-strategy-enhancements` branch.

# Checklist

- [‚úÖ] Design script structure and CLI arguments.
- [‚úÖ] Implement agent loading functionality.
- [‚úÖ] Implement agent backtesting logic using `TradingEnvironment`.
- [‚úÖ] Implement agent metrics calculation.
- [‚úÖ] Implement SPY data fetching.
- [‚úÖ] Implement SPY metrics calculation.
- [‚úÖ] Implement results output/logging.
- [‚úÖ] Add `argparse` for configuration.
- [‚úÖ] Add error handling and comments.
- [ ] Test script with a sample trained model.
- [ ] Ensure all metrics are calculated correctly.
- [‚úÖ] Commit script to `feature/rl-strategy-enhancements` branch. (Delegated to dev-git)
- [‚úÖ] Update this task status to "üü¢ Done" and inform coordinator.

# Notes & Logs
*   Consider reusing components from `reinforcestrategycreator/metrics_calculator.py` and `reinforcestrategycreator/data_fetcher.py` where appropriate.
*   Ensure the `TradingEnvironment` is initialized with the correct parameters for evaluation (e.g., test data split).