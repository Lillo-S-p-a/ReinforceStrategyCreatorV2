+++
# --- MDTM Task ---
id = "TASK-DB-LEAD-20250504000430"
title = "Implement PostgreSQL Schema & Setup for Metrics Storage"
status = "üü¢ Done"
created_date = "2025-05-04"
updated_date = "2025-05-04" # Update this if modifying later
type = "üõ†Ô∏è Chore" # Or Feature, Chore seems fitting for setup
priority = "üî¥ High"
assigned_to = "lead-db"
coordinator = "TASK-BE-LEAD-20250504000300" # This Backend Lead Task ID
# --- Relationships ---
related_tasks = ["TASK-BE-LEAD-20250504000300"]
related_docs = [
    ".ruru/docs/metrics_definitions.md",
    ".ruru/tasks/BACKEND_METRICS/TASK-BE-LEAD-20250504000300.md", # For context on overall goal
    "pyproject.toml" # For adding dependencies
    ]
# --- Context & Details ---
tags = ["database", "postgresql", "schema", "setup", "metrics", "sql", "sqlalchemy", "psycopg2"]
+++

# Task: Implement PostgreSQL Schema & Setup for Metrics Storage

## üéØ Goal

Define and implement the necessary PostgreSQL database schema and integrate the required libraries/connection logic into the Python project (`ReinforceStrategyCreatorV2`) to store performance metrics generated during training runs.

## üìñ Description

The Backend Lead (`TASK-BE-LEAD-20250504000300`) requires a persistent storage solution for performance metrics defined in `.ruru/docs/metrics_definitions.md`. A PostgreSQL database has been chosen.

This task involves:
1.  **Schema Definition:** Define the SQL `CREATE TABLE` statements or SQLAlchemy models for the following tables:
    *   `training_runs`: Metadata (run ID, start/end times, parameters, etc.).
    *   `episodes`: Episode summaries (episode ID, run ID, PnL, Sharpe, MDD, Reward, Steps, Win Rate, etc.).
    *   `steps`: Step-level data (step ID, episode ID, timestamp, portfolio value, reward, action, position). Consider indexing.
    *   `trades`: Closed trade details (trade ID, episode ID, entry/exit times/prices, quantity, PnL, costs).
    *   Ensure appropriate data types, constraints (primary/foreign keys, not null), and indexes are defined for efficient querying.
2.  **Dependency Management:** Add necessary Python libraries (e.g., `SQLAlchemy`, `psycopg2-binary`) to `pyproject.toml`.
3.  **Connection Setup:** Implement basic connection logic. Consider using environment variables or a configuration file for connection details (host, port, user, password, dbname). Provide utility functions or a class for establishing connections/sessions.
4.  **Initialization Script (Optional but Recommended):** Create a script or function to initialize the database schema (create tables if they don't exist).

## ‚úÖ Acceptance Criteria

*   SQL `CREATE TABLE` statements or SQLAlchemy models for `training_runs`, `episodes`, `steps`, and `trades` are defined and saved (e.g., in a `.sql` file or Python module).
*   Required database libraries are added to `pyproject.toml`.
*   Basic database connection logic is implemented and usable within the project.
*   A mechanism exists to create the defined tables in a target PostgreSQL database.
*   Connection details are handled securely (not hardcoded).

## üìã Checklist

*   [‚úÖ] Define schema for `training_runs` table.
*   [‚úÖ] Define schema for `episodes` table.
*   [‚úÖ] Define schema for `steps` table.
*   [‚úÖ] Define schema for `trades` table.
*   [‚úÖ] Add required dependencies to `pyproject.toml`.
*   [‚úÖ] Implement database connection configuration (e.g., using env vars).
*   [‚úÖ] Implement connection/session utility function/class.
*   [‚úÖ] Create schema initialization script/function.
*   [‚úÖ] Document connection setup and schema location.

## ü™µ Log

*   2025-05-04 - Task created and delegated by Backend Lead (`TASK-BE-LEAD-20250504000300`).
*   2025-05-04 - Implemented SQLAlchemy models in `reinforcestrategycreator/db_models.py`.
*   2025-05-04 - Added `sqlalchemy` and `psycopg2-binary` to `pyproject.toml`. Run `poetry install` to update environment.
*   2025-05-04 - Implemented connection utilities and schema initialization in `reinforcestrategycreator/db_utils.py`.
*   **Setup:**
    *   Ensure PostgreSQL server is running.
    *   Set the `DATABASE_URL` environment variable (e.g., in a `.env` file): `DATABASE_URL="postgresql://user:password@host:port/database_name"`
    *   Run the initialization function once to create tables: `python -c "from reinforcestrategycreator.db_utils import init_db; init_db()"` (ensure environment is activated, e.g., `poetry run python ...`).
    *   Use `get_db_session` from `db_utils` to interact with the database (e.g., `with get_db_session() as db: ...`).