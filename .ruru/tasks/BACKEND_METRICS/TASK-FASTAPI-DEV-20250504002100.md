+++
# --- MDTM Task ---
id = "TASK-FASTAPI-DEV-20250504002100"
title = "Implement FastAPI Endpoints for Metrics API"
status = "ðŸŸ¡ To Do" # Reverted: Testing via curl requested
created_date = "2025-05-04"
updated_date = "2025-05-05" # Keep updated date
type = "ðŸŒŸ Feature"
priority = "ðŸ”´ High"
assigned_to = "framework-fastapi"
coordinator = "TASK-BE-LEAD-20250504000300" # Backend Lead Task ID
# --- Relationships ---
related_tasks = ["TASK-BE-LEAD-20250504000300", "TASK-DB-LEAD-20250504000430", "TASK-PY-DEV-20250504000700"]
related_docs = [
    ".ruru/docs/metrics_definitions.md", # Defines metrics
    "reinforcestrategycreator/db_models.py", # DB Models
    "reinforcestrategycreator/db_utils.py", # DB Utilities
    "pyproject.toml" # For adding dependencies
    ]
# --- Context & Details ---
tags = ["api", "fastapi", "rest", "python", "metrics", "database", "sqlalchemy", "pydantic", "filtering", "aggregation", "security"]
+++

# Task: Implement FastAPI Endpoints for Metrics API

## ðŸŽ¯ Goal

Implement a RESTful API using FastAPI to expose the performance metrics stored in the PostgreSQL database. The API should provide endpoints for retrieving training runs, episodes, steps, and trades, with support for filtering and basic aggregation.

## ðŸ“– Description

The backend system now calculates and stores performance metrics in a PostgreSQL database. This task requires building the API layer using FastAPI:

1.  **Setup FastAPI:**
    *   Add `fastapi` and `uvicorn[standard]` to `pyproject.toml`.
    *   Create a new directory structure, e.g., `reinforcestrategycreator/api/` containing `main.py`, `routers/`, `schemas/`, `dependencies.py`.
2.  **Define Pydantic Schemas:** Create Pydantic models in `reinforcestrategycreator/api/schemas/` for request bodies (if any) and response data, mirroring relevant fields from `reinforcestrategycreator/db_models.py`.
3.  **Implement Database Dependency:** Create a FastAPI dependency (e.g., in `dependencies.py`) to manage SQLAlchemy sessions per request, using `reinforcestrategycreator/db_utils.py`.
4.  **Implement Routers & Endpoints:** Create API routers (e.g., `routers/runs.py`, `routers/episodes.py`) with the following endpoints:
    *   `GET /runs/`: List training runs (potentially with pagination and filtering by date).
    *   `GET /runs/{run_id}/`: Get details for a specific training run.
    *   `GET /runs/{run_id}/episodes/`: List episodes for a specific run. Implement filtering based on query parameters (e.g., `min_pnl`, `max_sharpe`, `start_date`, `end_date`). Add pagination.
    *   `GET /runs/{run_id}/episodes/summary/`: Calculate and return aggregated metrics (e.g., average/median PnL, Sharpe, MDD, Win Rate) for all episodes within the specified run.
    *   `GET /episodes/{episode_id}/`: Get details for a specific episode.
    *   `GET /episodes/{episode_id}/steps/`: List step data for an episode (implement pagination).
    *   `GET /episodes/{episode_id}/trades/`: List trades for an episode (implement pagination).
5.  **Database Interaction:** Use the SQLAlchemy models and the session dependency to query the database within the endpoint functions. Implement filtering logic based on query parameters.
6.  **Basic Security:** Implement simple API key authentication. Expect an API key in a header (e.g., `X-API-Key`). Create a dependency to validate the key against a configured value (e.g., from an environment variable). Protect all endpoints.
7.  **Error Handling:** Implement basic error handling (e.g., 404 Not Found for invalid IDs).
8.  **CORS:** Configure CORS middleware if the frontend will be served from a different origin.

## âœ… Acceptance Criteria

*   FastAPI application structure is created (`api/main.py`, `routers/`, `schemas/`, etc.).
*   Required dependencies (`fastapi`, `uvicorn`) are added to `pyproject.toml`.
*   Pydantic schemas for API responses are defined.
*   Database session dependency is implemented.
*   All specified API endpoints are implemented and functional.
*   Endpoints correctly query the database using SQLAlchemy.
*   Filtering by query parameters is implemented for relevant endpoints (e.g., `/runs/{run_id}/episodes/`).
*   Aggregation endpoint (`/runs/{run_id}/episodes/summary/`) is implemented.
*   Pagination is implemented for list endpoints (`/runs/`, `/episodes/`, `/steps/`, `/trades/`).
*   Basic API key authentication is implemented and protects all endpoints.
*   FastAPI automatically generated documentation (`/docs`) is available and reflects the implemented endpoints and schemas.
*   CORS is configured if necessary.

## ðŸ“‹ Checklist

*   [âœ…] Add `fastapi`, `uvicorn` to `pyproject.toml`.
*   [âœ…] Create API directory structure (`api/`, `routers/`, `schemas/`, etc.).
*   [âœ…] Define Pydantic schemas for responses.
*   [âœ…] Implement DB session dependency.
*   [âœ…] Implement router for `/runs/` endpoints.
*   [âœ…] Implement router for `/episodes/` endpoints.
*   [âœ…] Implement filtering for `GET /runs/{run_id}/episodes/`.
*   [âœ…] Implement aggregation for `GET /runs/{run_id}/episodes/summary/`.
*   [âœ…] Implement pagination for list endpoints.
*   [âœ…] Implement API key authentication dependency.
*   [âœ…] Protect all endpoints with the security dependency.
*   [âœ…] Configure CORS middleware (if needed).
*   [ ] Test endpoints manually (e.g., using `/docs` or curl).

## ðŸªµ Log

*   2025-05-04 - Task created and delegated by Backend Lead (`TASK-BE-LEAD-20250504000300`).